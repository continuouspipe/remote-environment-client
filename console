#!/bin/bash

function help {
	echo "Remote Environment client."
	echo
	echo "Usage:"
	echo "  "$0" command"
	echo 
	echo "Available commands:"
	echo "   setup             Setup the remote environment client"
	echo "   create            Create the remote environment"
	echo "   watch             Watch local changes and synchronize with the remote environment"
	echo "   ssh               SSH into the remote environment container"
	echo "   build             Update the remote environment with local changes"
	echo "   destroy           Destroy the remote environment"
}

command_exists () {
    type "$1" &> /dev/null ;
}

function get_current_namespace() {
    local  myresult='some value'
    echo "$myresult"
}

function dir {
    echo "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
}

function setup {
	if ! command_exists kubectl ; then
		echo "[INSTALL] kubectl is being installed"

		if [[ "$OSTYPE" == "darwin"* ]]; then
			curl -O https://storage.googleapis.com/kubernetes-release/release/v1.4.3/bin/darwin/amd64/kubectl
			chmod +x kubectl
			sudo mv kubectl /usr/local/bin/kubectl
		else
			curl -O https://storage.googleapis.com/kubernetes-release/release/v1.4.3/bin/linux/amd64/kubectl
			chmod +x kubectl
			sudo mv kubectl /usr/bin/kubectl
		fi
	else
		echo "[OK] kubectl found"
	fi

    #read -p "What is the name of the context? " CONTEXT_NAME
    ##read -p "What is the IP of the cluster? " CLUSTER_IP
    #read -p "What is the username? " USERNAME
    #read -p "What is the password? " PASSWORD
    #read -p "What is the default namespace you want to use? " NAMESPACE

    #kubectl config set-credentials $CONTEXT_NAME-$USERNAME --username=$USERNAME --password=$PASSWORD
    #kubectl config set-cluster $CONTEXT_NAME --server=https://$CLUSTER_IP --insecure-skip-tls-verify=true
    #kubectl config set-context $CONTEXT_NAME --cluster=$CONTEXT_NAME --user=$CONTEXT_NAME-$USERNAME
    #kubectl config use-context $CONTEXT_NAME

    echo "Created the context " $CONTEXT_NAME
    echo
    echo "Run 'kubectl cluster-info' to verify the connectivity."
    echo

    DIR=$(dir)

    read -p "What is the namespace you are using? " NAMESPACE_NAME
    echo -n $NAMESPACE_NAME > $DIR/.namespace

    read -p "What is your remote environment branch you are using? " REMOTE_BRANCH
    echo -n $REMOTE_BRANCH > $DIR/.branch

    read -p "What is your github remote name? " REMOTE_NAME
    echo -n $REMOTE_NAME > $DIR/.remote
}

function create {

    DIR=$(dir)
    REMOTE_NAME=`cat $DIR/.remote`
    REMOTE_BRANCH=`cat $DIR/.branch`
    LOCAL_BRANCH=`git rev-parse --abbrev-ref HEAD`

    echo "Pushing to remote"
    git push --force $REMOTE_NAME $LOCAL_BRANCH:$REMOTE_BRANCH

    echo "Continous Pipe will now build your developer environment"

}

function build {

    DIR=$(dir)
    REMOTE_NAME=`cat $DIR/.remote`
    REMOTE_BRANCH=`cat $DIR/.branch`
    LOCAL_BRANCH=`git rev-parse --abbrev-ref HEAD`

    git diff --exit-code --quiet $LOCAL_BRANCH $REMOTE_NAME/$REMOTE_BRANCH
    rc=$?; if [[ $rc = 0 ]]; then
        echo "No changes so making timestamp update only commit to force rebuild";
        gdate +%s > $DIR/../timestamp
        git commit $DIR/../timestamp -m "Update timestamp to force rebuild on continuous pipe"
    fi

    echo "Pushing to remote"
    git push --force $REMOTE_NAME $LOCAL_BRANCH:$REMOTE_BRANCH

    echo "Continous Pipe will now build your developer environment"

}

function ssh {
    NAMESPACE=`cat $(dir)/.namespace`
    POD=`kubectl --namespace=$NAMESPACE get pods | grep $1 | awk '{print $1}'`

    cmd="kubectl --namespace=$NAMESPACE exec -it $POD -- /bin/bash"
    echo "Running: '${cmd}'."
    eval ${cmd}
}

function watch {
    # Sync latency / speed in seconds
    LATENCY="1"

    PROJECT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
    PROJECT_DIR_WITH_DOT="$PROJECT_DIR/."
    NAMESPACE=`cat $(dir)/.namespace`
    POD=`kubectl --namespace=$NAMESPACE get pods | grep web | awk '{print $1}'`

    # Watch for changes and sync (exclude hidden files)
    echo    "Watching for changes. Quit anytime with Ctrl-C."
    fswatch -0 -r -l $LATENCY .. --exclude="/\.[^/]*$" --exclude="\.idea" --exclude="\.git" --exclude="___jb_old___" --exclude="___jb_tmp___" \
    | while read -d "" event
      do
        echo `date` "\"$event\" changed. Synchronizing... "
        file="${event/$PROJECT_DIR/$PROJECT_DIR_WITH_DOT}"
        echo $result_string

        rsync --relative -rlptDv -e 'kubectl --namespace='$NAMESPACE' exec -i '$POD -- $file --:/app
        echo "done."
      done
}

#while [[ $# -gt 0 ]]; do
	case $1 in
	    -h|--help|help)
	    help
	    exit 0
	    ;;
	    setup|create|build|watch|ssh)
	    COMMAND=$1
	    ;;
	    *)
	        echo "Unknown option: "$1
	    ;;
	esac

#	shift
#done

if [ -z ${COMMAND+x} ]; then 
	help
	exit 0
fi

case $COMMAND in
	setup)
		setup
		;;
	create)
    	create
    	;;
    watch)
        watch
        ;;
    build)
        build
        ;;
    ssh)
        ssh $2
        ;;
	*)
		echo "Command not found: "$COMMAND
		echo
		help
		exit 1
		;;
esac
